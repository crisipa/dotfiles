# Last Modified: Sun Jun 15 01:23:36 2025
abi <abi/4.0>,

include <tunables/global>

/opt/wechat/wechat {
  include <abstractions/base>
  include <abstractions/dri-common>
  include <abstractions/fonts>
  include <abstractions/gtk>
  include <abstractions/kde-open5>
  include <abstractions/mesa>
  include <abstractions/nameservice>
  include <abstractions/ssl_certs>
  include <abstractions/user-tmp>
  include <abstractions/wayland>

  # ÊãíÁªùÁâπÊùÉ
  deny capability sys_admin,
  deny capability sys_chroot,
  deny capability sys_ptrace,

  # ÈòªÊ≠¢ ÂæÆ‰ø° 
  deny ptrace read peer=*,
  deny ptrace read peer=/opt/**,
  deny ptrace read peer=/usr/bin/*,
  deny ptrace trace peer=*,
  deny ptrace trace peer=/opt/**,
  deny ptrace trace peer=/usr/bin/*,

  # ‰∏çÊÉ≥ËÆ© ÂæÆ‰ø° ËÆøÈóÆÁöÑ‰∏úË•ø
  deny /dev/disk/** r,
  deny /dev/disk/*/ r,
  deny /etc/* w,
  deny /etc/** w,
  deny /etc/caddy/* r,
  deny /etc/clash* r,
  deny /etc/cmdline.d/* r,
  deny /etc/cron.*/* r,
  deny /etc/nebula/* r,
  deny /etc/nginx/* r,
  deny /etc/ssh/* r,
  deny /etc/wireguard/* r,
  deny /proc/*/cgroup r,
  deny /proc/*/stat r,
  deny /proc/cmdline r,
  deny /proc/config.gz r,
  deny /proc/cpuinfo r,
  deny /proc/sys/fs/inotify/max_user_watches r,
  deny /proc/version r,
  
  # ‰∏çÂêØÂä®Â¥©Ê∫ÉÊä•Âëä
  deny /opt/wechat/RadiumWMPF/runtime/WeChatAppEx_crashpad_handler x,
  deny /opt/wechat/crashpad_handler x,
  
  # ‰∏çÁü•ÈÅì ÂæÆ‰ø° ËÆøÈóÆËøô‰∫õÂπ≤‰ªÄ‰πà
  deny /sys/bus/pci/devices/ r,
  deny /sys/devices/system/cpu/cpufreq/policy*/cpuinfo_max_freq r,
  deny /sys/devices/system/cpu/kernel_max r,
  deny /sys/devices/virtual/** r,
  deny /usr/bin/bash x,
  
  # ‰∏çÊÉ≥ËÆ© ÂæÆ‰ø° ËÆøÈóÆÁöÑ‰∏úË•ø
  deny owner /home/*/.config/chromium/* rw,
  deny owner /home/*/.config/chromium/** rw,
  deny owner /home/*/.mozilla/** rw,
  deny owner /home/*/.pki/nssdb/* w,
  deny owner /home/*/.ssh/* rw,
  deny owner /home/*/.steam/* rw,
  deny owner /home/*/.steam/** rw,
  deny owner /home/*/.sys1og.conf w,
  deny owner /home/*/.var/** rw,
  deny owner /home/*/Documents/* rw,

  # ÂüüÂêçËß£Êûê
  /etc/hosts r,
  /etc/resolv.conf r,
  
  # ÂæÆ‰ø° ÁöÑÊñá‰ª∂
  /opt/wechat/* r,
  /opt/wechat/*.so mr,
  /opt/wechat/*.so.* mr,
  /opt/wechat/RadiumWMPF/host/*.so mr,
  /opt/wechat/RadiumWMPF/runtime/*.so mr,
  /opt/wechat/RadiumWMPF/runtime/WeChatAppEx mrix,
  /opt/wechat/libvlc.so.* mr,
  /opt/wechat/wxocr mrix,
  /opt/wechat/wxplayer mrix,
  /opt/wechat/wxutility mrix,
  /proc/self/exe mrix,
  
  # ‰∏çÁü•ÈÅì ÂæÆ‰ø° ËÆøÈóÆËøô‰∫õÂπ≤‰ªÄ‰πà
  /proc/sys/kernel/yama/ptrace_scope r,
  /sys/devices/system/cpu/present r,
  /usr/share/icons/** r,
  audit /etc/hostname r,
  audit /proc/ r,
  audit /sys/class/net/ r,
  
  # ÁΩëÂç°Âú∞ÂùÄ
  audit /sys/devices/pci*/**/en*/address r,
  audit /sys/devices/pci*/**/et*/address r,
  audit /sys/devices/pci*/**/wl*/address r,
  
  # amd Ê†∏Êòæ
  audit /sys/devices/pci0000:00/0000:00:08.1/0000:36:00.0/* r,
  
  # Êú¨Âú∞Âú∞ÂùÄ
  audit /sys/devices/virtual/net/lo/address r,
  
  # ÁîµÂ≠êÂûÉÂúæüò°
  audit owner /dev/shm/.org.chromium.Chromium.* rw,
  
  # ËÆ© qq ËÆøÈóÆ ‰∏ãËΩΩ Êñá‰ª∂Â§π
  audit owner /home/*/Downloads/* rw,
  
  # x11 Á™óÂè£üò°
  audit owner /run/user/1000/xauth_* r,
  
  # Ê°åÈù¢ÈÖçÁΩÆ
  /usr/bin/xdg-open rPx -> wechat_xdg_open,
  owner /home/*/.config/gtk-*/* r,
  owner /home/*/.config/kdedefaults/kdeglobals r,
  owner /home/*/.config/kdeglobals r,
  owner /home/*/.config/user-dirs.dirs r,
  
  # ÂæÆ‰ø° ÁöÑÁî®Êà∑Êï∞ÊçÆ
  owner /home/*/.pki/nssdb/* r,
  owner /home/*/.xwechat/** rwk,
  owner /home/*/Documents/xwechat_files/** rwk,
  
  # ÂæÆ‰ø° ÁöÑ proc Ôºü
  owner /proc/*/cmdline r,
  owner /proc/*/fd/ r,
  owner /proc/*/mem r,
  owner /proc/*/oom_score_adj w,
  owner /proc/*/setgroups w,
  owner /proc/*/stat r,
  owner /proc/*/statm r,
  owner /proc/*/task/ r,
  owner /proc/*/task/** r,

  userns create,

}

profile wechat_xdg_open {
  include <abstractions/qt6>
  include <abstractions/xdg-open>

  # ÁúãËµ∑Êù•‰ºº‰πéÊ≤°ÊúâËµ∑Âà∞Â∫îÊúâÁöÑÈôêÂà∂ÊïàÊûú

#   /usr/bin/chromium{,-browser} Cx -> sanitized_helper,
#   /usr/bin/firefox rCx -> sanitized_helper,
#   /usr/lib{,64}/chromium{,-browser}/chromium{,-browser} Cx -> sanitized_helper,
#   /usr/lib{,64}/firefox*/firefox* Cx -> sanitized_helper,

}
